<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tide Level Data</title>
    <style>
        .red-text { color: red; }
        .yellow-cell { background-color: yellow; }
        .red-cell { background-color: red; }
    </style>
</head>
<body>
    <h1>Tide Level Data</h1>
    <div id="error-message" style="color: red;"></div>
    <div id="averages"></div>
    <table border="1">
        <thead>
            <tr>
                <th>時刻</th>
                <th>Tide</th>
                <th>Departure</th>
                <th>Adjusted Tide</th>
                <th>Adjusted Departure</th>
            </tr>
        </thead>
        <tbody id="tide-table-body">
        </tbody>
    </table>
    <h2>Astro Data</h2>
    <table border="1">
        <thead>
            <tr>
                <th>時刻</th>
                <th>Tide</th>
                <th>Adjusted Tide</th>
            </tr>
        </thead>
        <tbody id="astro-table-body">
        </tbody>
    </table>
    <script>
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        const year = today.getFullYear();
        const todayStr = today.toISOString().split('T')[0].replace(/-/g, '');
        const yesterdayStr = yesterday.toISOString().split('T')[0].replace(/-/g, '');
        const tomorrowStr = tomorrow.toISOString().split('T')[0].replace(/-/g, '');
        const todayKey = todayStr.slice(4);
        const tomorrowKey = tomorrowStr.slice(4);

        const tideUrl = `https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_${todayStr}_145681.json`;
        const tideBackupUrl = `https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_${yesterdayStr}_145681.json`;
        const astroUrl = `https://www.jma.go.jp/bosai/tidelevel/const/tide_astro/tide_astro_${year}_145681.json`;
        const astroNextYearUrl = `https://www.jma.go.jp/bosai/tidelevel/const/tide_astro/tide_astro_${tomorrow.getFullYear()}_145681.json`;

        async function fetchJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (e) {
                console.error(`Failed to fetch from ${url}`, e);
                throw e;
            }
        }

        function calculateAverage(arr, count) {
            const slice = arr.slice(-count);
            const sum = slice.reduce((acc, val) => acc + val, 0);
            return Math.round(sum / slice.length);
        }

        function createTableRow(time, tide, departure, adjustedTide, adjustedDeparture) {
            const tr = document.createElement('tr');

            const timeTd = document.createElement('td');
            timeTd.textContent = time;
            tr.appendChild(timeTd);

            const tideTd = document.createElement('td');
            tideTd.textContent = tide;
            if (tide >= 80 && tide < 130) tideTd.classList.add('yellow-cell');
            if (tide >= 130) tideTd.classList.add('red-cell');
            tr.appendChild(tideTd);

            const departureTd = document.createElement('td');
            departureTd.textContent = departure;
            if (departure >= 10) departureTd.classList.add('red-text');
            tr.appendChild(departureTd);

            const adjustedTideTd = document.createElement('td');
            adjustedTideTd.textContent = adjustedTide;
            if (adjustedTide >= 80 && adjustedTide < 130) adjustedTideTd.classList.add('yellow-cell');
            if (adjustedTide >= 130) adjustedTideTd.classList.add('red-cell');
            tr.appendChild(adjustedTideTd);

            const adjustedDepartureTd = document.createElement('td');
            adjustedDepartureTd.textContent = adjustedDeparture;
            if (adjustedDeparture >= 10) adjustedDepartureTd.classList.add('red-text');
            tr.appendChild(adjustedDepartureTd);

            return tr;
        }

        function createAstroTableRow(time, tide, adjustedTide) {
            const tr = document.createElement('tr');

            const timeTd = document.createElement('td');
            timeTd.textContent = time;
            tr.appendChild(timeTd);

            const tideTd = document.createElement('td');
            tideTd.textContent = tide;
            if (tide >= 80 && tide < 130) tideTd.classList.add('yellow-cell');
            if (tide >= 130) tideTd.classList.add('red-cell');
            tr.appendChild(tideTd);

            const adjustedTideTd = document.createElement('td');
            adjustedTideTd.textContent = adjustedTide;
            if (adjustedTide >= 80 && adjustedTide < 130) adjustedTideTd.classList.add('yellow-cell');
            if (adjustedTide >= 130) adjustedTideTd.classList.add('red-cell');
            tr.appendChild(adjustedTideTd);

            return tr;
        }

        async function displayTideData() {
            const errorMessageElement = document.getElementById('error-message');
            const averagesElement = document.getElementById('averages');
            let tideData;
            try {
                tideData = await fetchJson(tideUrl);
            } catch (e) {
                try {
                    tideData = await fetchJson(tideBackupUrl);
                } catch (e) {
                    errorMessageElement.textContent = '潮汐データの取得に失敗しました。';
                    return;
                }
            }

            const tide = tideData.tide;
            const departure = tideData.departure;
            const tideAvg = calculateAverage(tide, 241);
            const departureAvg = calculateAverage(departure, 241);

            averagesElement.innerHTML = `
                <p>Tide Average: ${tideAvg}</p>
                <p>Departure Average: ${departureAvg}</p>
            `;

            const tableBody = document.getElementById('tide-table-body');
            tideData.tide_obs.forEach(entry => {
                const adjustedTide = entry.tide + departureAvg;
                const adjustedDeparture = entry.departure + departureAvg;
                tableBody.appendChild(createTableRow(entry.time, entry.tide, entry.departure, adjustedTide, adjustedDeparture));
            });

            let astroData;
            try {
                astroData = await fetchJson(astroUrl);
            } catch (e) {
                errorMessageElement.textContent = '今年のアストロデータの取得に失敗しました。';
                return;
            }

            let tomorrowAstroData;
            try {
                tomorrowAstroData = await fetchJson(astroNextYearUrl);
            } catch (e) {
                errorMessageElement.textContent = '来年のアストロデータの取得に失敗しました。';
                return;
            }

            const todayAstro = astroData.tide[todayKey] || [];
            const tomorrowAstro = tomorrowAstroData.tide[tomorrowKey] || [];

            const astroTableBody = document.getElementById('astro-table-body');
            todayAstro.forEach((value, index) => {
                const time = `${String(index).padStart(2, '0')}:00`;
                const adjustedTide = value + departureAvg;
                astroTableBody.appendChild(createAstroTableRow(time, value, adjustedTide));
            });
            tomorrowAstro.forEach((value, index) => {
                const time = `${String(index).padStart(2, '0')}:00`;
                const adjustedTide = value + departureAvg;
                astroTableBody.appendChild(createAstroTableRow(time, value, adjustedTide));
            });
        }

        displayTideData();
    </script>
</body>
</html>
