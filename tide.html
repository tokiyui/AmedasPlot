<!DOCTYPE html>
<html>
<head>
  <title>Tide Data</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h1>Tide Data</h1>
  <div id="result"></div>

  <script>
    $(document).ready(function() {
      // 最新のデータを取得するURL
      var todayURL = "https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_(今日の日付YYYYMMDD)_145681.json";
      var yesterdayURL = "https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_(昨日の日付YYYYMMDD)_145681.json";

      // 今日の日付を取得
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      var todayDate = yyyy + mm + dd;

      // 昨日の日付を取得
      var yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      var yyyyYesterday = yesterday.getFullYear();
      var mmYesterday = String(yesterday.getMonth() + 1).padStart(2, '0');
      var ddYesterday = String(yesterday.getDate()).padStart(2, '0');
      var yesterdayDate = yyyyYesterday + mmYesterday + ddYesterday;

      // データ取得関数
      function getData(url) {
        return $.ajax({
          url: url,
          dataType: "json"
        });
      }

      // 最新のデータ取得
      getData(todayURL)
        .done(function(data) {
          processData(data);
        })
        .fail(function() {
          // データが存在しない場合は昨日のデータを取得
          getData(yesterdayURL)
            .done(function(data) {
              processData(data);
            })
            .fail(function() {
              displayError("データの取得に失敗しました。");
            });
        });

      // データ処理関数
      function processData(data) {
        var tideData = data.tide;
        var departureData = data.departure;
        var last241Tide = getLastNElements(tideData, 241);
        var last241Departure = getLastNElements(departureData, 241);
        var tideAverage = calculateAverage(last241Tide);
        var departureAverage = calculateAverage(last241Departure);

        // 結果表示
        displayResult(tideAverage, departureAverage);
      }

      // 配列の最後からN個の要素を取得する関数
      function getLastNElements(array, n) {
        return array.slice(Math.max(array.length - n, 0));
      }

      // 配列の平均値を計算する関数
      function calculateAverage(array) {
        var sum = array.reduce(function(a, b) {
          return a + b;
        }, 0);
        return Math.round(sum / array.length);
      }

      // 結果表示関数
      function displayResult(tideAverage, departureAverage) {
        var result = "Tide Average: " + tideAverage + "<br>";
        result += "Departure Average: " + departureAverage;
        $("#result").html(result);
      }

      // エラーメッセージ表示関数
      function displayError(message) {
        $("#result").html("Error: " + message);
      }
    });
  </script>
</body>
</html>
