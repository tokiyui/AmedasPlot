<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tide Level Data</title>
    <style>
        .red-text { color: red; }
        .yellow-cell { background-color: yellow; }
        .red-cell { background-color: red; }
    </style>
</head>
<body>
    <h1>Tide Level Data</h1>
    <div id="error-message" style="color: red;"></div>
    <div id="averages"></div>
    <table border="1">
        <thead>
            <tr>
                <th>時刻</th>
                <th>Tide</th>
                <th>Departure</th>
                <th>Adjusted Tide</th>
                <th>Adjusted Departure</th>
            </tr>
        </thead>
        <tbody id="tide-table-body">
        </tbody>
    </table>
    <h2>Astro Data</h2>
    <table border="1">
        <thead>
            <tr>
                <th>時刻</th>
                <th>Tide</th>
                <th>Adjusted Tide</th>
            </tr>
        </thead>
        <tbody id="astro-table-body">
        </tbody>
    </table>
    <script>
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        const year = today.getFullYear();
        const todayStr = today.toISOString().split('T')[0].replace(/-/g, '');
        const yesterdayStr = yesterday.toISOString().split('T')[0].replace(/-/g, '');
        const tomorrowStr = tomorrow.toISOString().split('T')[0].replace(/-/g, '');
        const todayKey = todayStr.slice(4);
        const tomorrowKey = tomorrowStr.slice(4);

        const tideUrl = `https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_${todayStr}_145681.json`;
        const tideBackupUrl = `https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_${yesterdayStr}_145681.json`;
        const astroUrl = `https://www.jma.go.jp/bosai/tidelevel/const/tide_astro/tide_astro_${year}_145681.json`;
        const astroNextYearUrl = `https://www.jma.go.jp/bosai/tidelevel/const/tide_astro/tide_astro_${tomorrow.getFullYear()}_145681.json`;

        async function fetchJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (e) {
                console.error(`Failed to fetch from ${url}`, e);
                throw e;
            }
        }

        function calculateAverage(arr, count) {
            const slice = arr.slice(-count);
            const sum = slice.reduce((acc, val) => acc + val, 0);
            return Math.round(sum / slice.length);
        }

        function createTableRow(time, tide, departure, adjustedTide, adjustedDeparture) {
            const tr = document.createElement('tr');

            const timeTd = document.createElement('td');
            timeTd.textContent = time;
            tr.appendChild(timeTd);

            const tideTd = document.createElement('td');
            tideTd.textContent = tide;
            if (tide >= 80 && tide < 130) tideTd.classList.add('yellow-cell');
            if (tide >= 130) tideTd.classList.add('red-cell');
            tr.appendChild(tideTd);

            const departureTd = document.createElement('td');
            departureTd.textContent = departure;
            if (departure >= 10) departureTd.classList.add('red-text');
            tr```html
.appendChild(departureTd);

            const adjustedTideTd = document.createElement('td');
            adjustedTideTd.textContent = adjustedTide;
            tr.appendChild(adjustedTideTd);

            const adjustedDepartureTd = document.createElement('td');
            adjustedDepartureTd.textContent = adjustedDeparture;
            tr.appendChild(adjustedDepartureTd);

            return tr;
        }

        async function displayData() {
            try {
                const tideData = await fetchJson(tideUrl);
                const astroData = await fetchJson(astroUrl);

                const tideTableBody = document.getElementById('tide-table-body');
                const astroTableBody = document.getElementById('astro-table-body');

                tideData.forEach((entry) => {
                    const { time, tide, departure } = entry;
                    const adjustedTide = tide - 100;
                    const adjustedDeparture = departure - 10;
                    tideTableBody.appendChild(createTableRow(time, tide, departure, adjustedTide, adjustedDeparture));
                });

                astroData.forEach((entry) => {
                    const { time, tide } = entry;
                    const adjustedTide = tide - 100;
                    astroTableBody.appendChild(createTableRow(time, tide, '', adjustedTide, ''));
                });

                const averageTide = calculateAverage(tideData.map(entry => entry.tide), 10);
                const averageDeparture = calculateAverage(tideData.map(entry => entry.departure), 10);

                const averagesDiv = document.getElementById('averages');
                averagesDiv.innerHTML = `Average Tide: ${averageTide}<br>Average Departure: ${averageDeparture}`;
            } catch (e) {
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = 'Failed to fetch data. Please try again later.';
            }
        }

        displayData();
    </script>
</body>
</html>
