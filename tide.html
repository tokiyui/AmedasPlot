<!DOCTYPE html>
<html>
<head>
  <style>
    table {
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
    }

    td.red {
      color: red;
    }

    td.yellow {
      background-color: yellow;
    }

    td.red-bg {
      background-color: red;
      color: white;
    }
  </style>
</head>
<body>
  <table id="data-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Tide</th>
        <th>Departure</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
    // Function to calculate the average of an array of numbers
    function calculateAverage(numbers) {
      const sum = numbers.reduce((acc, curr) => acc + curr, 0);
      return Math.round(sum / numbers.length);
    }

    // Function to fetch JSON data from the provided URL
    async function fetchData(url) {
      const response = await fetch(url);
      if (response.ok) {
        const data = await response.json();
        return data;
      } else {
        throw new Error('Error fetching data');
      }
    }

    // Function to add a row to the data table
    function addRow(time, tide, departure) {
      const tableBody = document.querySelector('#data-table tbody');
      const row = document.createElement('tr');
      const timeCell = document.createElement('td');
      const tideCell = document.createElement('td');
      const departureCell = document.createElement('td');

      timeCell.textContent = time;
      tideCell.textContent = tide;
      departureCell.textContent = departure;

      row.appendChild(timeCell);
      row.appendChild(tideCell);
      row.appendChild(departureCell);
      tableBody.appendChild(row);
    }

    // Function to process the fetched data
    function processData(data) {
      const tideData = data.tide;
      const departureData = data.departure;

      // Calculate averages
      const tideAverage = calculateAverage(tideData.slice(-241));
      const departureAverage = calculateAverage(departureData.slice(-241));

      // Add rows to the table
      Object.keys(tideData).forEach(date => {
        const tide = tideData[date];
        const departure = departureData[date];
        const time = `${data.time.slice(5, 10)}-${date}`;

        // Add departure average to each data point
        const tideWithAverage = tide.map(value => value + departureAverage);

        // Add row to the table
        addRow(time, tideWithAverage.join(','), departure);

        // Apply cell styles based on conditions
        const lastDeparture = departure[departure.length - 1];
        const lastTideWithAverage = tideWithAverage[tideWithAverage.length - 1];
        const departureCell = document.querySelector('#data-table tbody tr:last-child td:nth-child(3)');

        if (lastDeparture >= 10) {
          departureCell.classList.add('red');
        }

        if (lastTideWithAverage >= 130) {
          departureCell.classList.add('red-bg');
        } else if (lastTideWithAverage >= 80) {
          departureCell.classList.add('yellow');
        }
      });
    }

    // Fetch and process data from the provided URLs
    async function fetchDataAndProcess() {
      const todayURL = 'https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_20240711_145681.json';
      const yesterdayURL = 'https://www.jma.go.jp/bosai/tidelevel/data/tide/tide_obs_20240710_145681.json';
      let data;

      try {
        data = await fetchData(todayURL);
      } catch (error) {
        // Fetch yesterday's data if today's data is unavailable
        data = await fetchData(yesterdayURL);
      }

      processData(data);
    }

    // Call the main function to fetch and process data
    fetchDataAndProcess();
  </script>
</body>
</html>
