<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>日本の上空気温一覧</title>
  <style>
    table { border-collapse: collapse; margin: 1em 0; width: 100%; }
    th, td { border: 1px solid #999; padding: 0.5em; text-align: center; }
  </style>
</head>
<body>
  <h1>日本の850hPa・925hPa気温一覧（UWYO）</h1>
  <table id="data-table">
    <thead>
      <tr>
        <th>地点</th>
        <th>WMO</th>
        <th>日付(00Z)</th>
        <th>可能最高気温</th>
        <th>850T</th>
        <th>925T</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const stations = [
      { wmo: "47401", name: "稚内" },
      { wmo: "47412", name: "札幌" },
      { wmo: "47418", name: "釧路" },
      { wmo: "47582", name: "秋田" },
      { wmo: "47646", name: "館野" },
      { wmo: "47678", name: "八丈島" },
      { wmo: "47741", name: "松江" },
      { wmo: "47778", name: "潮岬" },
      { wmo: "47807", name: "福岡" },
      { wmo: "47827", name: "鹿児島" },
    ];

    const tableBody = document.querySelector("#data-table tbody");

    const proxyUrls = [
      url => `https://corsproxy.io/?url=${encodeURIComponent(url)}`,
      url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    ];

    async function fetchWithFallback(url) {
      for (const proxy of proxyUrls) {
        try {
          const res = await fetch(proxy(url));
          if (!res.ok) continue;
          return await res.text();
        } catch {}
      }
      throw new Error("すべてのプロキシで取得失敗");
    }

    // UTC 90分前を切り捨てて、その日の00:00に固定
    function getDateString() {
      const now = new Date();
      const utc = new Date(now.getTime() + now.getTimezoneOffset() * 60000);
      utc.setMinutes(utc.getMinutes() - 90);
      utc.setUTCHours(0, 0, 0, 0);
      return `${utc.getUTCFullYear()}-${String(utc.getUTCMonth() + 1).padStart(2, '0')}-${String(utc.getUTCDate()).padStart(2, '0')} 0:00:00`;
    }

    async function fetchData(wmo, datetime) {
      const baseUrl = `https://weather.uwyo.edu/wsgi/sounding?datetime=${encodeURIComponent(datetime)}&id=${wmo}&src=FM35&type=TEXT:LIST`;
      const text = await fetchWithFallback(baseUrl);
      const lines = text.split("\n");
      const data = { date: datetime };
      for (let line of lines) {
        const cols = line.trim().split(/\s+/);
        if (cols.length >= 3) {
          const p = cols[0];
          const t = cols[2];
          if (p === "850.0") data["850"] = parseFloat(t);
          if (p === "925.0") data["925"] = parseFloat(t);
        }
      }
      return data;
    }

    async function displayAll() {
      const datetime = getDateString();
      for (const station of stations) {
        const row = document.createElement("tr");
        try {
          const temps = await fetchData(station.wmo, datetime);
          row.innerHTML = `
            <td>${station.name}</td>
            <td>${station.wmo}</td>
            <td>${datetime.split(' ')[0]}</td>
            <td>${(temps["925"] != null && temps["850"] != null)
                  ? ((temps["925"] * 2 + temps["850"]) / 3 + 15).toFixed(1)
                  : "N/A"}</td>
            <td>${temps["850"] ?? "N/A"}</td>
            <td>${temps["925"] ?? "N/A"}</td>
          `;
        } catch (err) {
          console.error(`${station.name} (${station.wmo}) の取得に失敗:`, err);
          row.innerHTML = `
            <td>${station.name}</td>
            <td>${station.wmo}</td>
            <td>${datetime.split(' ')[0]}</td>
            <td colspan="3">取得失敗</td>
          `;
        }
        tableBody.appendChild(row);
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }

    displayAll();
  </script>
</body>
</html>
